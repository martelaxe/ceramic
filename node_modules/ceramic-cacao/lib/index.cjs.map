{"version":3,"file":"index.cjs","sources":["../src/abnf.ts","../src/siwe.ts","../src/cacao.ts"],"sourcesContent":["import apgApi from 'apg-js/src/apg-api/api.js'\nimport apgLib from 'apg-js/src/apg-lib/node-exports.js'\n\nconst GRAMMAR = `\nsign-in-with-ethereum =\n    domain %s\" wants you to sign in with your Ethereum account:\" LF\n    address LF\n    LF\n    [ statement LF ]\n    LF\n    %s\"URI: \" URI LF\n    %s\"Version: \" version LF\n    %s\"Nonce: \" nonce LF\n    %s\"Issued At: \" issued-at\n    [ LF %s\"Expiration Time: \" expiration-time ]\n    [ LF %s\"Not Before: \" not-before ]\n    [ LF %s\"Request ID: \" request-id ]\n    [ LF %s\"Chain ID: \" chain-id ]\n    [ LF %s\"Resources:\"\n    resources ]\n\ndomain = dnsauthority\n\naddress = \"0x\" 40*40HEXDIG\n    ; Must also conform to captilization\n    ; checksum encoding specified in EIP-55\n    ; where applicable (EOAs).\n\nstatement = *( reserved / unreserved / \" \" )\n    ; The purpose is to exclude LF (line breaks).\n\nversion = \"1\"\n\nnonce = 8*( ALPHA / DIGIT )\n\nissued-at = date-time\nexpiration-time = date-time\nnot-before = date-time\n\nrequest-id = *pchar\n\nchain-id = 1*DIGIT\n    ; See EIP-155 for valid CHAIN_IDs.\n\nresources = *( LF resource )\n\nresource = \"- \" URI\n\n; ------------------------------------------------------------------------------\n; RFC 3986\n\nURI           = scheme \":\" hier-part [ \"?\" query ] [ \"#\" fragment ]\n\nhier-part     = \"//\" authority path-abempty\n              / path-absolute\n              / path-rootless\n              / path-empty\n\nscheme        = ALPHA *( ALPHA / DIGIT / \"+\" / \"-\" / \".\" )\n\nauthority     = [ userinfo \"@\" ] host [ \":\" port ]\nuserinfo      = *( unreserved / pct-encoded / sub-delims / \":\" )\nhost          = IP-literal / IPv4address / reg-name\nport          = *DIGIT\n\nIP-literal    = \"[\" ( IPv6address / IPvFuture  ) \"]\"\n\nIPvFuture     = \"v\" 1*HEXDIG \".\" 1*( unreserved / sub-delims / \":\" )\n\nIPv6address   =                            6( h16 \":\" ) ls32\n              /                       \"::\" 5( h16 \":\" ) ls32\n              / [               h16 ] \"::\" 4( h16 \":\" ) ls32\n              / [ *1( h16 \":\" ) h16 ] \"::\" 3( h16 \":\" ) ls32\n              / [ *2( h16 \":\" ) h16 ] \"::\" 2( h16 \":\" ) ls32\n              / [ *3( h16 \":\" ) h16 ] \"::\"    h16 \":\"   ls32\n              / [ *4( h16 \":\" ) h16 ] \"::\"              ls32\n              / [ *5( h16 \":\" ) h16 ] \"::\"              h16\n              / [ *6( h16 \":\" ) h16 ] \"::\"\n\nh16           = 1*4HEXDIG\nls32          = ( h16 \":\" h16 ) / IPv4address\nIPv4address   = dec-octet \".\" dec-octet \".\" dec-octet \".\" dec-octet\ndec-octet     = DIGIT                 ; 0-9\n                 / %x31-39 DIGIT         ; 10-99\n                 / \"1\" 2DIGIT            ; 100-199\n                 / \"2\" %x30-34 DIGIT     ; 200-249\n                 / \"25\" %x30-35          ; 250-255\n\nreg-name      = *( unreserved / pct-encoded / sub-delims )\n\npath-abempty  = *( \"/\" segment )\npath-absolute = \"/\" [ segment-nz *( \"/\" segment ) ]\npath-rootless = segment-nz *( \"/\" segment )\npath-empty    = 0pchar\n\nsegment       = *pchar\nsegment-nz    = 1*pchar\n\npchar         = unreserved / pct-encoded / sub-delims / \":\" / \"@\"\n\nquery         = *( pchar / \"/\" / \"?\" )\n\nfragment      = *( pchar / \"/\" / \"?\" )\n\npct-encoded   = \"%\" HEXDIG HEXDIG\n\nunreserved    = ALPHA / DIGIT / \"-\" / \".\" / \"_\" / \"~\"\nreserved      = gen-delims / sub-delims\ngen-delims    = \":\" / \"/\" / \"?\" / \"#\" / \"[\" / \"]\" / \"@\"\nsub-delims    = \"!\" / \"$\" / \"&\" / \"'\" / \"(\" / \")\"\n              / \"*\" / \"+\" / \",\" / \";\" / \"=\"\n\n; ------------------------------------------------------------------------------\n; RFC 4501\n\ndnsauthority    = host [ \":\" port ]\n                             ; See RFC 3986 for the\n                             ; definition of \"host\" and \"port\".\n\n; ------------------------------------------------------------------------------\n; RFC 3339\n\ndate-fullyear   = 4DIGIT\ndate-month      = 2DIGIT  ; 01-12\ndate-mday       = 2DIGIT  ; 01-28, 01-29, 01-30, 01-31 based on\n                          ; month/year\ntime-hour       = 2DIGIT  ; 00-23\ntime-minute     = 2DIGIT  ; 00-59\ntime-second     = 2DIGIT  ; 00-58, 00-59, 00-60 based on leap second\n                          ; rules\ntime-secfrac    = \".\" 1*DIGIT\ntime-numoffset  = (\"+\" / \"-\") time-hour \":\" time-minute\ntime-offset     = \"Z\" / time-numoffset\n\npartial-time    = time-hour \":\" time-minute \":\" time-second\n                  [time-secfrac]\nfull-date       = date-fullyear \"-\" date-month \"-\" date-mday\nfull-time       = partial-time time-offset\n\ndate-time       = full-date \"T\" full-time\n\n; ------------------------------------------------------------------------------\n; RFC 5234\n\nALPHA          =  %x41-5A / %x61-7A   ; A-Z / a-z\nLF             =  %x0A\n                  ; linefeed\nDIGIT          =  %x30-39\n                  ; 0-9\nHEXDIG         =  DIGIT / \"A\" / \"B\" / \"C\" / \"D\" / \"E\" / \"F\"\n`\n\nexport class ParsedMessage {\n  domain: string\n  address: string\n  statement: string\n  uri: string\n  version: string\n  nonce: string\n  issuedAt: string\n  expirationTime: string | null\n  notBefore: string | null\n  requestId: string | null\n  chainId: string | null\n  resources: Array<string> | null\n\n  constructor(msg: string) {\n    const api = new apgApi(GRAMMAR)\n    api.generate()\n    if (api.errors.length) {\n      console.error(api.errorsToAscii())\n      console.error(api.linesToAscii())\n      console.log(api.displayAttributeErrors())\n      throw new Error(`ABNF grammar has errors`)\n    }\n\n    const grammarObj = api.toObject()\n    const parser = new apgLib.parser()\n    parser.ast = new apgLib.ast()\n    const id = apgLib.ids\n\n    const domain = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.domain = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks.domain = domain\n    const address = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.address = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks.address = address\n    const statement = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.statement = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks.statement = statement\n    const uri = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        if (!data.uri) {\n          data.uri = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n        }\n      }\n      return ret\n    }\n    parser.ast.callbacks.uri = uri\n    const version = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.version = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks.version = version\n    const chainId = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.chainId = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks['chain-id'] = chainId\n    const nonce = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.nonce = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks.nonce = nonce\n    const issuedAt = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.issuedAt = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks['issued-at'] = issuedAt\n    const expirationTime = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.expirationTime = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks['expiration-time'] = expirationTime\n    const notBefore = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.notBefore = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks['not-before'] = notBefore\n    const requestId = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.requestId = apgLib.utils.charsToString(chars, phraseIndex, phraseLength)\n      }\n      return ret\n    }\n    parser.ast.callbacks['request-id'] = requestId\n    const resources = function (state, chars, phraseIndex, phraseLength, data) {\n      const ret = id.SEM_OK\n      if (state === id.SEM_PRE) {\n        data.resources = apgLib.utils\n          .charsToString(chars, phraseIndex, phraseLength)\n          .slice(3)\n          .split('\\n- ')\n      }\n      return ret\n    }\n    parser.ast.callbacks.resources = resources\n\n    const result = parser.parse(grammarObj, 'sign-in-with-ethereum', msg)\n    if (!result.success) {\n      throw new Error(`Invalid message: ${JSON.stringify(result)}`)\n    }\n    const elements = {}\n    parser.ast.translate(elements)\n    for (const [key, value] of Object.entries(elements)) {\n      this[key] = value\n    }\n  }\n}\n","import type { Cacao } from './cacao.js'\nimport { ParsedMessage as ABNFParsedMessage } from './abnf.js'\nimport { AccountId, ChainId } from 'caip'\n\n/**\n * Possible message error types.\n */\nexport enum ErrorTypes {\n  /**Thrown when the `validate()` function can verify the message. */\n  INVALID_SIGNATURE = 'Invalid signature.',\n  /**Thrown when the `expirationTime` is present and in the past. */\n  EXPIRED_MESSAGE = 'Expired message.',\n  /**Thrown when some required field is missing. */\n  MALFORMED_SESSION = 'Malformed session.',\n}\n\n/**\n * Possible signature types that this library supports.\n */\nexport enum SignatureType {\n  /**EIP-191 signature scheme */\n  PERSONAL_SIGNATURE = 'Personal signature',\n}\n\nexport class SiweMessage {\n  /**RFC 4501 dns authority that is requesting the signing. */\n  domain: string\n  /**Ethereum address performing the signing conformant to capitalization\n   * encoded checksum specified in EIP-55 where applicable. */\n  address: string\n  /**Human-readable ASCII assertion that the user will sign, and it must not\n   * contain `\\n`. */\n  statement?: string\n  /**RFC 3986 URI referring to the resource that is the subject of the signing\n   *  (as in the __subject__ of a claim). */\n  uri: string\n  /**Current version of the message. */\n  version: string\n  /**Randomized token used to prevent replay attacks, at least 8 alphanumeric\n   * characters. */\n  nonce?: string\n  /**ISO 8601 datetime string of the current time. */\n  issuedAt?: string\n  /**ISO 8601 datetime string that, if present, indicates when the signed\n   * authentication message is no longer valid. */\n  expirationTime?: string\n  /**ISO 8601 datetime string that, if present, indicates when the signed\n   * authentication message will become valid. */\n  notBefore?: string\n  /**System-specific identifier that may be used to uniquely refer to the\n   * sign-in request. */\n  requestId?: string\n  /**EIP-155 Chain ID to which the session is bound, and the network where\n   * Contract Accounts must be resolved. */\n  chainId?: string\n  /**List of information or references to information the user wishes to have\n   * resolved as part of authentication by the relying party. They are\n   * expressed as RFC 3986 URIs separated by `\\n- `. */\n  resources?: Array<string>\n  /**Signature of the message signed by the wallet. */\n  signature?: string\n  /**Type of sign message to be generated. */\n  type?: SignatureType\n\n  /**\n   * Creates a parsed Sign-In with Ethereum Message (EIP-4361) object from a\n   * string or an object. If a string is used an ABNF parser is called to\n   * validate the parameter, otherwise the fields are attributed.\n   * @param param {string | SiweMessage} Sign message as a string or an object.\n   */\n  constructor(param: string | Partial<SiweMessage>) {\n    if (typeof param === 'string') {\n      const parsedMessage = new ABNFParsedMessage(param)\n      this.domain = parsedMessage.domain\n      this.address = parsedMessage.address\n      this.statement = parsedMessage.statement\n      this.uri = parsedMessage.uri\n      this.version = parsedMessage.version\n      this.nonce = parsedMessage.nonce\n      this.issuedAt = parsedMessage.issuedAt\n      this.expirationTime = parsedMessage.expirationTime\n      this.notBefore = parsedMessage.notBefore\n      this.requestId = parsedMessage.requestId\n      this.chainId = parsedMessage.chainId\n      this.resources = parsedMessage.resources\n    } else {\n      Object.assign(this, param)\n    }\n  }\n\n  /**\n   * Creates a parsed Sign-In with Ethereum Message (EIP-4361) object from\n   * a CACAO object.\n   * @param cacao {Cacao} CACAO capability to convert to a SIWE\n   * @returns a new {SiweMessage}\n   */\n  static fromCacao(cacao: Cacao): SiweMessage {\n    const account = AccountId.parse(cacao.p.iss.replace('did:pkh:', ''))\n    const siwe = new SiweMessage({\n      domain: cacao.p.domain,\n      address: account.address,\n      uri: cacao.p.aud,\n      version: cacao.p.version,\n      chainId: new ChainId(account.chainId).reference,\n    })\n\n    if (cacao.p.statement) siwe.statement = cacao.p.statement\n    if (cacao.p.nonce) siwe.nonce = cacao.p.nonce\n    if (cacao.p.iat) siwe.issuedAt = cacao.p.iat\n    if (cacao.p.exp) siwe.expirationTime = cacao.p.exp\n    if (cacao.p.nbf) siwe.notBefore = cacao.p.nbf\n    if (cacao.p.requestId) siwe.requestId = cacao.p.requestId\n    if (cacao.p.resources) siwe.resources = cacao.p.resources\n\n    if (cacao.s) {\n      if (cacao.s.s) siwe.signature = cacao.s.s\n      if (cacao.s.t === 'eip191') siwe.type = SignatureType.PERSONAL_SIGNATURE\n    }\n\n    return siwe\n  }\n\n  /**\n   * This function can be used to retrieve an EIP-4361 formated message for\n   * signature, although you can call it directly it's advised to use\n   * [signMessage()] instead which will resolve to the correct method based\n   * on the [type] attribute of this object, in case of other formats being\n   * implemented.\n   * @returns {string} EIP-4361 formated message, ready for EIP-191 signing.\n   */\n  toMessage(): string {\n    const header = `${this.domain} wants you to sign in with your Ethereum account:`\n    const uriField = `URI: ${this.uri}`\n    let prefix = [header, this.address].join('\\n')\n    const versionField = `Version: ${this.version}`\n\n    if (!this.nonce) {\n      this.nonce = (Math.random() + 1).toString(36).substring(4)\n    }\n\n    const nonceField = `Nonce: ${this.nonce}`\n\n    const suffixArray = [uriField, versionField, nonceField]\n\n    if (this.issuedAt) {\n      Date.parse(this.issuedAt)\n    }\n    this.issuedAt = this.issuedAt ? this.issuedAt : new Date().toISOString()\n    suffixArray.push(`Issued At: ${this.issuedAt}`)\n\n    if (this.expirationTime) {\n      const expiryField = `Expiration Time: ${this.expirationTime}`\n\n      suffixArray.push(expiryField)\n    }\n\n    if (this.notBefore) {\n      suffixArray.push(`Not Before: ${this.notBefore}`)\n    }\n\n    if (this.requestId) {\n      suffixArray.push(`Request ID: ${this.requestId}`)\n    }\n\n    if (this.chainId) {\n      suffixArray.push(`Chain ID: ${this.chainId}`)\n    }\n\n    if (this.resources) {\n      suffixArray.push([`Resources:`, ...this.resources.map((x) => `- ${x}`)].join('\\n'))\n    }\n\n    const suffix = suffixArray.join('\\n')\n\n    if (this.statement) {\n      prefix = [prefix, this.statement].join('\\n\\n')\n    }\n\n    return [prefix, suffix].join('\\n\\n')\n  }\n\n  /**\n   * This method parses all the fields in the object and creates a sign\n   * message according with the type defined.\n   * @returns {string} Returns a message ready to be signed according with the\n   * type defined in the object.\n   */\n  signMessage(): string {\n    let message: string\n    switch (this.type) {\n      case SignatureType.PERSONAL_SIGNATURE: {\n        message = this.toMessage()\n        break\n      }\n\n      default: {\n        message = this.toMessage()\n        break\n      }\n    }\n    return message\n  }\n}\n","import { verifyMessage } from '@ethersproject/wallet'\nimport * as dagCbor from '@ipld/dag-cbor'\nimport * as multiformats from 'multiformats'\nimport * as Block from 'multiformats/block'\nimport { sha256 as hasher } from 'multiformats/hashes/sha2'\nimport { SiweMessage } from './siwe.js'\nimport { AccountId } from 'caip'\n\nexport type Header = {\n  t: 'eip4361'\n}\n\nexport type Payload = {\n  domain: string\n  iss: string\n  aud: string\n  version: string\n  nonce: string\n  iat: string\n  nbf?: string\n  exp?: string\n  statement?: string\n  requestId?: string\n  resources?: Array<string>\n}\n\nexport type Signature = {\n  t: 'eip191' | 'eip1271'\n  s: string\n}\nexport type Cacao = {\n  h: Header\n  p: Payload\n  s?: Signature\n}\n\nexport type VerifyOptions = {\n  /**\n   * @param atTime - the point in time the capability is being verified for\n   */\n  atTime?: Date\n}\n\nexport namespace Cacao {\n  export function fromSiweMessage(siweMessage: SiweMessage): Cacao {\n    const cacao: Cacao = {\n      h: {\n        t: 'eip4361',\n      },\n      p: {\n        domain: siweMessage.domain,\n        iat: siweMessage.issuedAt,\n        iss: `did:pkh:eip155:${siweMessage.chainId}:${siweMessage.address}`,\n        aud: siweMessage.uri,\n        version: siweMessage.version,\n        nonce: siweMessage.nonce,\n      },\n    }\n\n    if (siweMessage.signature) {\n      cacao.s = {\n        t: 'eip191',\n        s: siweMessage.signature,\n      }\n    }\n\n    if (siweMessage.notBefore) {\n      cacao.p.nbf = siweMessage.notBefore\n    }\n\n    if (siweMessage.expirationTime) {\n      cacao.p.exp = siweMessage.expirationTime\n    }\n\n    if (siweMessage.statement) {\n      cacao.p.statement = siweMessage.statement\n    }\n\n    if (siweMessage.requestId) {\n      cacao.p.requestId = siweMessage.requestId\n    }\n\n    if (siweMessage.resources) {\n      cacao.p.resources = siweMessage.resources\n    }\n\n    return cacao\n  }\n\n  export function verify(cacao: Cacao, options: VerifyOptions = {}) {\n    if (cacao.h.t === 'eip4361' && cacao.s?.t === 'eip191') {\n      return verifyEIP191Signature(cacao, options)\n    }\n    throw new Error('Unsupported CACAO signature type')\n  }\n\n  export function verifyEIP191Signature(cacao: Cacao, options: VerifyOptions) {\n    if (!cacao.s) {\n      throw new Error(`CACAO does not have a signature`)\n    }\n\n    const atTime = options.atTime ? options.atTime.getTime() : Date.now()\n\n    if (Date.parse(cacao.p.iat) > atTime || Date.parse(cacao.p.nbf) > atTime) {\n      throw new Error(`CACAO is not valid yet`)\n    }\n\n    if (Date.parse(cacao.p.exp) < atTime) {\n      throw new Error(`CACAO has expired`)\n    }\n\n    const msg = SiweMessage.fromCacao(cacao)\n    const sig = cacao.s.s\n    const recoveredAddress = verifyMessage(msg.toMessage(), sig)\n    const issAddress = AccountId.parse(cacao.p.iss.replace('did:pkh:', '')).address\n    if (recoveredAddress.toLowerCase() !== issAddress.toLowerCase()) {\n      throw new Error(`Signature does not belong to issuer`)\n    }\n  }\n}\n\nexport type CacaoBlock = {\n  value: Cacao\n  cid: multiformats.CID\n  bytes: Uint8Array\n}\n\nexport namespace CacaoBlock {\n  export async function fromCacao(cacao: Cacao): Promise<CacaoBlock> {\n    const block = await Block.encode<Cacao, number, number>({\n      value: cacao,\n      codec: dagCbor,\n      hasher: hasher,\n    })\n    return block\n  }\n}\n"],"names":["GRAMMAR","ParsedMessage","constructor","msg","domain","address","statement","uri","version","nonce","issuedAt","expirationTime","notBefore","requestId","chainId","resources","api","apgApi","generate","errors","length","console","error","errorsToAscii","linesToAscii","log","displayAttributeErrors","Error","grammarObj","toObject","parser","apgLib","ast","id","ids","state","chars","phraseIndex","phraseLength","data","ret","SEM_OK","SEM_PRE","utils","charsToString","callbacks","slice","split","result","parse","success","JSON","stringify","elements","translate","key","value","Object","entries","ErrorTypes","SignatureType","SiweMessage","param","signature","type","parsedMessage","ABNFParsedMessage","assign","fromCacao","cacao","account","AccountId","p","iss","replace","siwe","aud","ChainId","reference","iat","exp","nbf","s","t","PERSONAL_SIGNATURE","toMessage","header","uriField","prefix","join","versionField","Math","random","toString","substring","nonceField","suffixArray","Date","toISOString","push","expiryField","map","x","suffix","signMessage","message","Cacao","fromSiweMessage","siweMessage","h","verify","options","verifyEIP191Signature","atTime","getTime","now","sig","recoveredAddress","verifyMessage","issAddress","toLowerCase","CacaoBlock","Block","encode","codec","dagCbor","hasher"],"mappings":"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"}